<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>おすすめの予定表</title>
    <link rel="stylesheet" href="TextFile2.css">
    <script type="text/javascript" src=".APIkey/apikey.js"></script>

</head>


<body>
    <header>
        <h1 id="title2"></h1>
        <a class="title" href="./index.html"><img src="20210124_1_mikan_01.png"></a>
        <nav class="nav">
            <ul class="menu-group">
                <li class="menu-item"><a href="./ViewPoint.html">オススメの観光地診断</a></li>
                <li class="menu-item"><a href="./RecommendedPlan.html">オススメ予定表</a></li>
            </ul>
        </nav>
    </header>
    <style>
        .title img {
            height: 100px;
            margin: auto;
        }

        header {
            display: flex;
            width: 100%;
            height: 60px;
            background-color: #fff;
            align-items: center;
            opacity: 0.8;
            position: fixed;
            margin: 0;
            padding: 0;
        }

        .menu-item {
            list-style: none;
            display: inline-block;
            color: #212529;
        }

        .labelA {
            width: 200px;
        }

        .labelB {
            width: 55px;
        }

        .labelC {
            width: 20px;
        }

    </style>
</body>


<body class="gradient">
    <br><br>

    <!--<div class="text">-->                <!--スライドアニメーション-->
    <!--<h1 class="title">-->
    <!--<span>おすすめの予定表</span>-->
    <!--</h1>-->
    <!--<p class="sentence">-->
    <!--<span>！あなたにあった旅の経路を作成！</span>-->
    <!--</p>-->
    <!--</div>-->
    <!--</style>-->



    <center><h1><b>おすすめの予定表</b></h1></center>
    <center>！あなたにあった旅の経路を作成！</center>

    <center><h2>行きたい観光地</h2></center>

    <center><table border="1" cellpadding="10"></center> <!--ここは観光場所入力するところ-->
    <tr>
        <td></td>
        <td>地点名</td>
        <td>滞在時間<br>(時間)</td>
    </tr>
    <tr>
        <td>出発地</td>
        <td><label><input type="text" id="origin" class="labelA"></label></td>
        <td></td>
    </tr>
    <tr>
        <td>目的地１</td>
        <td><label><input type="text" id="destination1" class="labelA"></label></td>
        <td><label><input type="text" id="StayTime1" class="labelB"></label></td>
    </tr>
    <tr>
        <td>目的地２</td>
        <td><label><input type="text" id="destination2" class="labelA"></label></td>
        <td><label><input type="text" id="StayTime2" class="labelB"></label></td>
    </tr>
    <tr>
        <td>目的地３</td>
        <td><label><input type="text" id="destination3" class="labelA"></label></td>
        <td><label><input type="text" id="StayTime3" class="labelB"></label></td>
    </tr>
    <tr>
        <td>目的地４</td>
        <td><label><input type="text" id="destination4" class="labelA"></label></td>
        <td><label><input type="text" id="StayTime4" class="labelB"></label></td>
    </tr>
    </table>　　　　　　　　　　　　　　　　　　　　　　<!--ここまで観光場所入力-->



    <center>移動手段は？</center>
    <form name="howtogo">
        <!--ここは交通手段選択場所-->
        <div class="radio-wrap">
            <input type="radio" name="test" value="自家用車">自家用車
            <!--<input type="radio" name="test" value="公共交通機関">公共交通機関-->

        </div>
    </form>　　　　　　　　　　<!--ここまで交通手段選択場所-->


    <center>出発時間は？</center>
    <label><input type="text" id="StartHour" class="labelC"></label>
    時
    <label><input type="text" id="StartMinute" class="labelC"></label>
    分


    <!--<center>どうする？</center>
    <form name="when come here">-->
    <!--ここでなんかやる-->
    <!--<div class="radio-wrapp">
        <input type="radio" name="testt" value="First">1
        <input type="radio" name="testt" value="Second">2
        <input type="radio" name="testt" value="Third">3
        <input type="radio" name="testt" value="Fourth">4
        <br>
        <center><button type="button" onclick="functionNum(1)">1のボタン</button></center>
    </div>
    </form>　　-->
    <!--ここまででなんかやる-->



    <br>
    <button onclick="main()">検索！</button>

    <p id="msg"></p>

    <div id="route"></div>
    <div id="duration"></div>

    <script>
        async function loadMapsAPI() {
            return new Promise((resolve, reject) => {
                if (typeof google == 'undefined') {
                    var script = document.createElement('script');
                    script.src = "https://maps.google.com/maps/api/js?key=" + config.apikey + "&libraries=places";
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                } else {
                    resolve();
                }
            });
        }

        function findNearestHotelAndTravelTime(n) {
            return new Promise((resolve, reject) => {
                console.log(n);
                var facilityNam;
                if (n == 1) {
                    facilityName = document.getElementById('destination1').value;
                }
                if (n == 2) {
                    facilityName = document.getElementById('destination2').value;
                }
                if (n == 3) {
                    facilityName = document.getElementById('destination3').value;
                }
                if (n == 4) {
                    facilityName = document.getElementById('destination4').value;
                }

                const request = {
                    query: facilityName + " ホテル",
                    fields: ["name", "geometry"]
                };

                const service = new google.maps.places.PlacesService(document.createElement('div'));
                service.textSearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {

                        resolve(results[0].formatted_address);


                    } else {
                        alert("ホテルが見つかりませんでした。");
                    }
                });

            });
        }

        async function CheckHotel(NowTime, Time, n) {
            var durationContainer = document.getElementById('duration');


            if (NowTime[0] * 3600 + NowTime[1] * 60 + NowTime[2] + Time >= 18 * 3600) {
                var Adress = await findNearestHotelAndTravelTime(n);
                var adress = Adress.substr(Adress.indexOf(' ') + 1);
                console.log(adress);
                console.log(document.getElementById('origin').value);

                if (n == 1) {
                    var time = await calculateTime(document.getElementById('origin').value, adress);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + '到着<br>';
                    NowTime[0] = 9;
                    NowTime[1] = 0;
                    NowTime[2] = 0;
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + "出発<br>";
                    var time = await calculateTime(adress, document.getElementById('destination1').value);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination1.value + '到着<br>';

                }

                if (n == 2) {
                    var time = await calculateTime(document.getElementById('destination1').value, adress);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + '到着<br>';
                    NowTime[0] = 9;
                    NowTime[1] = 0;
                    NowTime[2] = 0;
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + "出発<br>";
                    var time = await calculateTime(adress, document.getElementById('destination2').value);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination2.value + '到着<br>';

                }

                if (n == 3) {
                    var time = await calculateTime(document.getElementById('destination2').value, adress);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + '到着<br>';
                    NowTime[0] = 9;
                    NowTime[1] = 0;
                    NowTime[2] = 0;
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + "出発<br>";
                    var time = await calculateTime(adress, document.getElementById('destination3').value);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination3.value + '到着<br>';

                }

                if (n == 4) {
                    var time = await calculateTime(document.getElementById('destination3').value, adress);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + '到着<br>';
                    NowTime[0] = 9;
                    NowTime[1] = 0;
                    NowTime[2] = 0;
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + adress + "出発<br>";
                    var time = await calculateTime(adress, document.getElementById('destination4').value);
                    NowTime = await TimeAdd(NowTime, time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination4.value + '到着<br>';

                }



            }
            else {
                if (n == 1) {
                    NowTime = await TimeAdd(NowTime, Time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination1.value + '到着<br>';
                }
                if (n == 2) {
                    NowTime = await TimeAdd(NowTime, Time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination2.value + '到着<br>';
                }
                if (n == 3) {
                    NowTime = await TimeAdd(NowTime, Time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination3.value + '到着<br>';
                }
                if (n == 4) {
                    NowTime = await TimeAdd(NowTime, Time);
                    durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination4.value + '到着<br>';
                }


            }

            return NowTime;


        }

        var NowTime = [0, 0, 0];

        async function TimeDisp(time1, time2, time3, time4, timeL) {
            var durationContainer = document.getElementById('duration');


            
            console.log(time1, time2, time3, time4, timeL);
            durationContainer.innerHTML = ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + document.getElementById('origin').value + '出発<br>';
            NowTime = CheckHotel(NowTime, time1, 1);
            NowTime = await TimeAdd(NowTime, 0);
            durationContainer.innerHTML += '';
            NowTime = await TimeAdd(NowTime, document.getElementById('StayTime1').value * 3600);
            durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination1.value + '出発<br>';


            if (time2 != -1) {
                NowTime = await CheckHotel(NowTime, time2, 2);
                NowTime = await TimeAdd(NowTime, document.getElementById('StayTime2').value * 3600);
                durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination2.value + '出発<br>';
            }
            if (time3 != -1) {
                NowTime = await CheckHotel(NowTime, time3, 3);
                NowTime = await TimeAdd(NowTime, document.getElementById('StayTime3').value * 3600);
                durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination3.value + '出発<br>';
            }
            if (time4 != -1) {
                NowTime = await CheckHotel(NowTime, time4, 4);
                NowTime = await TimeAdd(NowTime, document.getElementById('StayTime4').value * 3600);
                durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + destination4.value + '出発<br>';
            }


            NowTime = await TimeAdd(NowTime, timeL);
            durationContainer.innerHTML += ('00' + NowTime[0]).slice(-2) + ':' + ('00' + NowTime[1]).slice(-2) + '：' + document.getElementById('origin').value + '到着<br>';
            console.log(NowTime[0], NowTime[1], NowTime[2]);



        }

        async function TimeAdd(NowTime, time) {
            return new Promise((resolve, reject) => {
                NowTime[2] += time;
                if (NowTime[2] >= 60) {
                    NowTime[1] += Math.floor(NowTime[2] / 60);
                    NowTime[2] = NowTime[2] % 60;
                }
                if (NowTime[1] >= 60) {
                    NowTime[0] += Math.floor(NowTime[1] / 60);
                    NowTime[1] = NowTime[1] % 60;
                }
                console.log(NowTime);
                resolve(NowTime);
            });
        }



        async function main() {
            var time1 = -1;
            var time2 = -1;
            var time3 = -1;
            var time4 = -1;
            var timeL = -1;

            await loadMapsAPI();
            NowTime = await TimeAdd(NowTime, StartHour.value * 3600 + StartMinute.value * 60);
            time1 = await calculateTime(document.getElementById('origin').value, document.getElementById('destination1').value);

            if (destination2.value == '') {
                timeL = await calculateTime(document.getElementById('destination1').value, document.getElementById('origin').value);
            }
            else {
                time2 = await calculateTime(document.getElementById('destination1').value, document.getElementById('destination2').value);
                if (destination3.value == '') {
                    timeL = await calculateTime(document.getElementById('destination2').value, document.getElementById('origin').value);
                }
                else {
                    time3 = await calculateTime(document.getElementById('destination2').value, document.getElementById('destination3').value);
                    if (destination4.value == '') {
                        timeL = await calculateTime(document.getElementById('destination3').value, document.getElementById('origin').value);
                    }
                    else {
                        time4 = await calculateTime(document.getElementById('destination3').value, document.getElementById('destination4').value);
                        timeL = await calculateTime(document.getElementById('destination4').value, document.getElementById('origin').value);
                    }
                }
            }
            TimeDisp(time1, time2, time3, time4, timeL);


            return;
        }

        async function calculateTime(origin, destination) {
            console.log(origin, destination);
            return new Promise((resolve, reject) => {
                var routeContainer = document.getElementById('route');
                var durationContainer = document.getElementById('duration');
                var geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: origin }, function (results, status) {
                    if (status === google.maps.GeocoderStatus.OK) {
                        var originLocation = results[0].geometry.location;
                        geocoder.geocode({ address: destination }, function (results, status) {
                            if (status === google.maps.GeocoderStatus.OK) {
                                var destinationLocation = results[0].geometry.location;
                                var map = new google.maps.Map(routeContainer, {
                                    center: originLocation,
                                    zoom: 13
                                });
                                var directionsService = new google.maps.DirectionsService();
                                var directionsRenderer = new google.maps.DirectionsRenderer({
                                    map: map
                                });
                                var request = {
                                    origin: originLocation,
                                    destination: destinationLocation,
                                    travelMode: google.maps.TravelMode.DRIVING
                                };
                                directionsService.route(request, function (response, status) {
                                    if (status === google.maps.DirectionsStatus.OK) {
                                        directionsRenderer.setDirections(response);
                                        var route = response.routes[0];
                                        console.log(origin.value + "から" + destination.value + "まで" + route.legs[0].duration.value);
                                        var duration = route.legs[0].duration.text;

                                        resolve(route.legs[0].duration.value);


                                    } else {
                                        durationContainer.textContent = '経路情報の取得に失敗しました。';
                                    }
                                });
                            } else {
                                durationContainer.textContent = '目標地点が見つかりません。';
                            }
                        });
                    } else {
                        durationContainer.textContent = '出発地点が見つかりません。';
                    }
                });
            });
        }
    </script>
</body>
</html>
